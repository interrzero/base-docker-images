name: Create Release Tag

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  actions: read
  contents: write
  packages: write
  security-events: write

jobs:
  detect_changed_images:
    runs-on: ubuntu-latest
    outputs:
      images_matrix: ${{ steps.build_matrix.outputs.images_to_build }}
      has_changes: ${{ steps.build_matrix.outputs.has_changes }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          token: "${{ secrets.PAT_TOKEN }}"
          fetch-depth: 0

      - name: Detect changed Dockerfiles and build matrix
        id: build_matrix
        run: |
          images_to_build=()
          # Find all Dockerfiles that are not deprecated
          for dockerfile in $(find . -maxdepth 1 -name 'Dockerfile.*' ! -name 'deprecated.Dockerfile.*'); do
            # Ensure we only check files that exist in the current HEAD
            if [ ! -f "$dockerfile" ]; then
              continue
            fi
            image_name=$(echo "$dockerfile" | sed 's|./Dockerfile\.||')
            latest_tag=$(git for-each-ref --sort='-v:refname' --format '%(refname:short)' refs/tags/release/$image_name | head -n 1)

            if [ -z "$latest_tag" ]; then
              echo "No tags found for $image_name, adding to build matrix."
              images_to_build+=("$image_name")
              continue
            fi

            # Check if the Dockerfile has changed since the last tag
            if ! git diff --quiet $latest_tag HEAD -- "$dockerfile"; then
              echo "$dockerfile has changed since last tag ($latest_tag), adding to build matrix."
              images_to_build+=("$image_name")
            fi
          done

          if [ ${#images_to_build[@]} -eq 0 ]; then
            echo "No Dockerfile changes detected."
            echo "images_to_build=[]" >> $GITHUB_OUTPUT
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Found changed images: ${images_to_build[@]}"
            output_string="["
            for item in "${images_to_build[@]}"; do
              output_string+="\"$item\", "
            done
            output_string=$(echo "$output_string" | sed 's/, $//')"]"
            echo "images_to_build=$output_string" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Exit early if no changes
        if: steps.build_matrix.outputs.has_changes != 'true'
        run: |
          echo "No Dockerfile changes detected in this commit, exiting."
          exit 0

  create_release_tags:
    needs: detect_changed_images
    if: needs.detect_changed_images.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        image_name: ${{ fromJSON(needs.detect_changed_images.outputs.images_matrix) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          token: "${{ secrets.PAT_TOKEN }}"
          fetch-depth: 0

      - name: Display processing image
        run: |
          echo "Processing image: ${{ matrix.image_name }}"

      - name: Find latest tag for image
        id: latest_tag
        run: |
          echo "Looking for existing tags for ${{ matrix.image_name }}..."
          latest=$(git for-each-ref --sort='-v:refname' \
            --format '%(refname:short)' \
            refs/tags/release/${{ matrix.image_name }} | head -n 1)

          if [ -n "$latest" ]; then
            # Extract semver from tag (remove 'v' prefix)
            semver=$(echo "$latest" | grep -oP 'v\d+\.\d+\.\d+' | sed 's/v//')
            echo "Found latest tag: $latest (version: $semver)"
          else
            semver="0.0.0"
            echo "No existing tags found, starting from $semver"
          fi

          echo "current_semver=$semver" >> $GITHUB_OUTPUT

      - name: Calculate next version
        id: next_version
        uses: "WyriHaximus/github-action-next-semvers@v1"
        with:
          version: ${{ steps.latest_tag.outputs.current_semver }}

      - name: Display version information
        run: |
          echo "Current version: ${{ steps.latest_tag.outputs.current_semver }}"
          echo "Next patch version: ${{ steps.next_version.outputs.patch }}"
          echo "Next minor version: ${{ steps.next_version.outputs.minor }}"
          echo "Next major version: ${{ steps.next_version.outputs.major }}"

      - name: Create and push release tag
        if: github.event.ref == 'refs/heads/main'
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # Configure git for bot user
          git config user.email "i0-baseimages-bot@users.noreply.github.com"
          git config user.name "i0 Base Images Bot"

          # Configure git to use the token for authentication
          git config --global url."https://x-access-token:${GH_TOKEN}@github.com/".insteadOf "https://github.com/"

          # Create new tag with next patch version
          new_tag="release/${{ matrix.image_name }}/v${{ steps.next_version.outputs.patch }}"
          tag_message="Release ${{ matrix.image_name }}/v${{ steps.next_version.outputs.patch }}"

          echo "Creating tag: $new_tag"
          echo "Tag message: $tag_message"

          git tag -a "$new_tag" -m "$tag_message"
          git push origin "$new_tag"

          echo "âœ… Successfully created and pushed tag: $new_tag"
