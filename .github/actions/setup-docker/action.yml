name: 'Setup Docker Environment'
description: 'Sets up Docker buildx, QEMU, and logs into GHCR'
inputs:
  registry:
    description: 'Container registry URL'
    required: true
    default: 'ghcr.io'
  username:
    description: 'Registry username'
    required: true
  password:
    description: 'Registry password/token'
    required: true
  platform:
    description: 'Target platform (e.g., linux/amd64)'
    required: false
    default: 'unknown'
outputs:
  cache-key:
    description: 'Generated cache key for builds'
    value: ${{ steps.cache-key.outputs.key }}

runs:
  using: 'composite'
  steps:
    - name: Login to Container Registry
      uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
      with:
        registry: ${{ inputs.registry }}
        username: ${{ inputs.username }}
        password: ${{ inputs.password }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

    - name: Set up QEMU
      uses: docker/setup-qemu-action@c7c53464625b32c7a7e944ae62b3e17d2b600130 # v3
      with:
        platforms: all

    - name: Generate cache key
      id: cache-key
      shell: bash
      run: |
        platform_safe=$(echo "${{ inputs.platform }}" | sed 's/\//-/g')
        echo "key=${{ github.repository }}-docker-${{ runner.os }}-${platform_safe}" >> $GITHUB_OUTPUT